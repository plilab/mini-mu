def list_map f xs k :=
  xs . [ Nil -> Nil . k
        | List:: x xs' -> 
            do
              y <- f x,
              ys' <- list_map f xs',
            then List:: y ys' . k ];

def inc x k := S x . k;

def lt a b k := 
  a . [ Z -> b . [ Z -> False . k | S b' -> True . k ]
       | S a' -> b . [ Z -> False . k | S b' -> lt @ a' b' k ] ];

def for_loop i end xs body k :=
  lt @ i end [ is_less ->
    is_less . [ True ->
                  body @ i xs [ xs' ->
                    S i . [ i_next -> for_loop @ i_next end xs' body k ] ]
              | False -> xs . k ] ];

def map_once i xs k := list_map @ inc xs k;

run for_loop @ 0 (let three = 3 in three) (List:: 2 (List:: 1 (List:: 0 Nil))) map_once Halt